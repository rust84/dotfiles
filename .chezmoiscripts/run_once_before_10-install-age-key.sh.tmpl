#!{{ lookPath "bash" }}

# Define colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Function to print a message with a color
print_msg() {
	local msg=$1
	local color=$2
	echo -e "${color}${msg}${NC}"
}

print_msg "Installing AGE key ========================================================" $YELLOW

# Check if age key already exists and has content
if [ -s {{ .chezmoi.homeDir }}/.config/age/keys.txt ]; then
  print_msg "Age key already exists, skipping..." $GREEN
  exit 0
fi

# Setup fedora cli utils
{{ if (eq .os "fedora") -}}
  print_msg "Detected Fedora, installing tools" $GREEN

  # install pre-reqs
  sudo dnf upgrade
  sudo dnf install -y jq gnupg
  mkdir -p {{ .chezmoi.homeDir }}/.config/age/
  touch {{ .chezmoi.homeDir }}/.config/age/keys.txt

  # 1Password CLI login (requires 1Password desktop app with CLI integration enabled)
  eval $(op signin)

  op read "op://Personal/Age key/notesPlain" > ~/.config/age/keys.txt
{{ end -}}